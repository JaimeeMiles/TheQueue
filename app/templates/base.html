<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}The Queue{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Login Overlay - blocks page until employee logs in -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>The Queue</h2>
            <p>Enter your employee number to continue</p>
            <div class="login-input-row">
                <input type="text" id="login-emp-id" class="login-input" placeholder="Employee #" maxlength="3" autocomplete="off" inputmode="numeric">
                <button id="login-submit-btn" class="login-submit-btn">Go</button>
            </div>
            <div id="login-error" class="login-error"></div>
        </div>
    </div>

    <header class="header">
        <div class="header-left">
            <h1>The Queue</h1>
        </div>
        <div class="header-employee">
            <span id="employee-name" class="employee-name"></span>
            <a href="#" id="switch-employee" class="switch-link">Not you?</a>
        </div>
        <nav class="header-nav">
            {% if workcells %}
            <select class="dept-selector" onchange="if(this.value) window.location.href=this.value">
                <option value="">Switch Work Cell...</option>
                {% for wc in workcells %}
                <option value="{{ url_for('views.queue', workcell_id=wc.id) }}"
                    {% if workcell_id == wc.id %}selected{% endif %}>
                    {{ wc.name }}
                </option>
                {% endfor %}
            </select>
            {% endif %}
            <a href="{{ url_for('views.index') }}" class="back-link">All Work Cells</a>
        </nav>
    </header>
    
    <main class="container">
        {% block content %}{% endblock %}
    </main>
    
    <script>
    // Employee login management
    const loginOverlay = document.getElementById('login-overlay');
    const loginInput = document.getElementById('login-emp-id');
    const loginError = document.getElementById('login-error');
    const employeeNameDisplay = document.getElementById('employee-name');
    const switchLink = document.getElementById('switch-employee');
    
    function getStoredEmployee() {
        try {
            const stored = localStorage.getItem('thequeue_employee');
            return stored ? JSON.parse(stored) : null;
        } catch (err) {
            console.error('Error reading stored employee:', err);
            return null;
        }
    }
    
    function setStoredEmployee(empId, name) {
        localStorage.setItem('thequeue_employee', JSON.stringify({id: empId, name: name}));
    }
    
    function clearStoredEmployee() {
        localStorage.removeItem('thequeue_employee');
    }
    
    function showLogin(prefillId) {
        loginOverlay.style.display = 'flex';
        loginInput.value = prefillId || '';
        loginError.textContent = '';
        loginInput.focus();
        if (prefillId) {
            loginInput.select();
        }
    }
    
    function hideLogin() {
        loginOverlay.style.display = 'none';
    }
    
    function updateEmployeeDisplay(name) {
        employeeNameDisplay.textContent = name;
    }
    
    async function validateEmployee(empId) {
        try {
            const response = await fetch(`/api/employee/${empId}`);
            if (response.ok) {
                return await response.json();
            }
            return null;
        } catch (err) {
            console.error('Error validating employee:', err);
            return null;
        }
    }
    
    // Check on page load - smart auto-login
    document.addEventListener('DOMContentLoaded', async function() {
        const stored = getStoredEmployee();
        
        if (stored && stored.id && stored.name) {
            // Show name immediately (trust localStorage for instant UX)
            updateEmployeeDisplay(stored.name);
            
            // Validate in background - only show login if it fails
            const validated = await validateEmployee(stored.id);
            if (validated) {
                // Update stored data in case name changed
                setStoredEmployee(validated.EmpID, validated.Name);
                updateEmployeeDisplay(validated.Name);
            } else {
                // Validation failed - show login with prefilled ID
                showLogin(stored.id);
                loginError.textContent = 'Please re-enter your employee number';
            }
        } else {
            // No stored employee - show login immediately
            showLogin();
        }
    });
    
    // Handle login input
    async function submitLogin() {
        const empId = loginInput.value.trim();
        if (!empId) {
            loginError.textContent = 'Please enter your employee number';
            return;
        }
        
        loginError.textContent = 'Checking...';
        const employee = await validateEmployee(empId);
        
        if (employee) {
            setStoredEmployee(employee.EmpID, employee.Name);
            updateEmployeeDisplay(employee.Name);
            hideLogin();
        } else {
            loginError.textContent = 'Employee not found';
            loginInput.select();
        }
    }
    
    loginInput.addEventListener('keypress', async function(e) {
        if (e.key === 'Enter') {
            submitLogin();
        }
    });
    
    // Handle login button click
    document.getElementById('login-submit-btn').addEventListener('click', submitLogin);
    
    // Handle switch employee
    switchLink.addEventListener('click', function(e) {
        e.preventDefault();
        const current = getStoredEmployee();
        clearStoredEmployee();
        showLogin(current ? current.id : '');
    });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
