{% extends "base.html" %}

{% block title %}The Queue - Inserts Dashboard{% endblock %}

{% block content %}
<style>
/* ============================================
   INSERTS DASHBOARD - CLEAN DARK MODE
   ============================================ */

.container {
    background: #121212;
    min-height: 100vh;
}

.queue-header {
    background: #1e1e1e !important;
    border-bottom: 1px solid #333 !important;
}

.queue-header h2 {
    color: #f0f0f0 !important;
}

.queue-header .back-btn {
    color: #90caf9 !important;
}

.queue-header .refresh-btn {
    background: #333 !important;
    color: #f0f0f0 !important;
    border: 1px solid #444 !important;
}

/* Filter row */
.inserts-filter-row {
    padding: 14px 20px;
    background: #1e1e1e;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    gap: 20px;
}

.inserts-filter-row label {
    color: #bbb;
    font-weight: 500;
    font-size: 0.9rem;
}

.inserts-input {
    padding: 8px 14px;
    font-size: 0.9rem;
    background: #2a2a2a;
    color: #f0f0f0;
    border: 1px solid #444;
    border-radius: 4px;
    min-width: 200px;
}

.inserts-input:focus {
    outline: none;
    border-color: #666;
}

.inserts-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
}

.inserts-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.inserts-toggle label {
    cursor: pointer;
}

/* Dashboard container */
.inserts-dashboard {
    background: #121212;
}

/* Table */
.inserts-table {
    width: 100%;
    border-collapse: collapse;
}

.inserts-table th {
    background: #2a2a2a;
    color: #999;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    border-bottom: 1px solid #333;
    white-space: nowrap;
}

.inserts-table th.col-desc {
    text-align: left;
}

.inserts-table td {
    padding: 12px 8px;
    color: #e8e8e8;
    border-bottom: 1px solid #2a2a2a;
    font-size: 0.9rem;
}

/* Group dividers - vertical bars */
.inserts-table th.group-start,
.inserts-table td.group-start {
    border-left: 2px solid #555;
}

/* Group header row */
.inserts-table thead tr.group-header th {
    background: #1e1e1e;
    border-bottom: none;
    padding-bottom: 4px;
    font-size: 0.75rem;
    color: #80cbc4;
}

.inserts-table thead tr.group-header th.group-start {
    border-left: 2px solid #555;
}

/* Normal rows */
.inserts-table tbody tr {
    background: #1a1a1a;
    transition: background 0.1s ease;
}

.inserts-table tbody tr:hover {
    background: #252525;
}

/* Shortage rows - medium gray */
.inserts-table tbody tr.has-shortage {
    background: #3a3a3a;
}

.inserts-table tbody tr.has-shortage:hover {
    background: #444;
}

.inserts-table tbody tr.hidden {
    display: none;
}

/* Column styles */
.col-part {
    width: 100px;
    text-align: center;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 0.85rem;
    color: #80cbc4;
    font-weight: 500;
}

.col-desc {
    text-align: left;
    color: #ccc;
}

.col-num {
    width: 65px;
    min-width: 55px;
    text-align: center;
    font-variant-numeric: tabular-nums;
}

.col-sets {
    width: 55px;
    min-width: 45px;
    text-align: center;
    font-variant-numeric: tabular-nums;
    color: #f0a0a0;
}

/* Highlight shortage columns */
.col-short {
    color: #f0a0a0;
}

/* Totals row */
.inserts-table tfoot tr {
    background: #2a2a2a;
}

.inserts-table tfoot td {
    border-top: 2px solid #444;
    padding: 12px 8px;
    color: #fff;
    font-weight: 600;
}

/* Count */
.inserts-count {
    padding: 12px 20px;
    background: #1e1e1e;
    color: #777;
    font-size: 0.85rem;
    margin: 0;
    border-top: 1px solid #333;
}

.no-data {
    padding: 60px 20px;
    text-align: center;
    color: #666;
    font-size: 1rem;
    background: #121212;
}

/* ============================================
   MODAL - DARK
   ============================================ */

.inserts-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75);
}

.inserts-modal-content {
    background: #1e1e1e;
    margin: 10% auto;
    border-radius: 8px;
    width: 380px;
    max-width: 90%;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    border: 1px solid #333;
}

.inserts-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #333;
}

.inserts-modal-header h3 {
    margin: 0;
    color: #f0f0f0;
    font-size: 1rem;
    font-weight: 600;
}

.inserts-modal-close {
    font-size: 22px;
    color: #666;
    cursor: pointer;
    line-height: 1;
}

.inserts-modal-close:hover {
    color: #fff;
}

.inserts-modal-body {
    padding: 20px;
}

.inserts-form-row {
    display: flex;
    align-items: center;
    margin-bottom: 14px;
}

.inserts-form-row label {
    width: 90px;
    color: #888;
    font-size: 0.85rem;
}

.inserts-form-row span {
    color: #e8e8e8;
    font-size: 0.95rem;
}

#kanban-qty {
    padding: 10px 12px;
    font-size: 1.1rem;
    background: #2a2a2a;
    color: #fff;
    border: 1px solid #444;
    border-radius: 4px;
    width: 100px;
    text-align: center;
}

#kanban-qty:focus {
    outline: none;
    border-color: #666;
}

.inserts-message {
    padding: 10px 12px;
    border-radius: 4px;
    text-align: center;
    margin-top: 12px;
    font-size: 0.9rem;
    display: none;
}

.inserts-message.success {
    display: block;
    background: #1b4332;
    color: #95d5b2;
}

.inserts-message.error {
    display: block;
    background: #442222;
    color: #f0a0a0;
}

.inserts-message.processing {
    display: block;
    background: #1e3a5f;
    color: #90caf9;
}

.inserts-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 14px 20px;
    border-top: 1px solid #333;
}

.inserts-btn {
    padding: 10px 20px;
    font-size: 0.9rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.inserts-btn-cancel {
    background: #333;
    color: #ccc;
}

.inserts-btn-cancel:hover {
    background: #444;
}

.inserts-btn-submit {
    background: #2e7d32;
    color: #fff;
}

.inserts-btn-submit:hover {
    background: #388e3c;
}

.inserts-btn-submit:disabled {
    background: #333;
    color: #666;
    cursor: not-allowed;
}

/* Make rows clickable */
.inserts-table tbody tr {
    cursor: pointer;
}
</style>

<div class="queue-header">
    <div class="queue-title-row">
        <a href="{{ url_for('views.index') }}" class="back-btn">‚Üê Back</a>
        <h2>Inserts - Gen 3 Demand</h2>
    </div>
    <button onclick="location.reload()" class="refresh-btn">üîÑ Refresh</button>
</div>

{% if inserts %}
<div class="inserts-filter-row">
    <label>Search:</label>
    <input type="text" id="search-input" class="inserts-input" placeholder="Filter by part or description..." autocomplete="off">
    
    <div class="inserts-toggle">
        <input type="checkbox" id="hide-no-shortage">
        <label for="hide-no-shortage">Hide if no shortage</label>
    </div>
</div>
{% endif %}

<div id="inserts-dashboard" class="inserts-dashboard">
    {% if inserts %}
    <table class="inserts-table" id="inserts-table">
        <thead>
            <tr class="group-header">
                <th colspan="3"></th>
                <th colspan="3" class="group-start">Total Demand</th>
                <th colspan="3" class="group-start">In Production</th>
            </tr>
            <tr>
                <th class="col-part">Part</th>
                <th class="col-desc">Description</th>
                <th class="col-num">On Hand</th>
                <th class="col-num group-start">Need</th>
                <th class="col-num col-short">Short</th>
                <th class="col-sets">Sets x4</th>
                <th class="col-num group-start">Need</th>
                <th class="col-num col-short">Short</th>
                <th class="col-sets">Sets x4</th>
            </tr>
        </thead>
        <tbody>
            {% for insert in inserts %}
            <tr class="insert-row{% if insert.ShortProd > 0 %} has-shortage{% endif %}" 
                data-partnum="{{ insert.PartNum }}"
                data-description="{{ insert.PartDescription or '' }}"
                data-shortage="{{ insert.ShortTotal or 0 }}">
                <td class="col-part">{{ insert.PartNum }}</td>
                <td class="col-desc">{{ insert.PartDescription or '-' }}</td>
                <td class="col-num">{{ (insert.OnHand or 0)|int }}</td>
                <td class="col-num group-start">{{ (insert.TotalNeed or 0)|int }}</td>
                <td class="col-num col-short">{{ (insert.ShortTotal or 0)|int if insert.ShortTotal > 0 else '-' }}</td>
                <td class="col-sets">{{ insert.SetsTotal if insert.SetsTotal > 0 else '-' }}</td>
                <td class="col-num group-start">{{ (insert.InProd or 0)|int if insert.InProd else '-' }}</td>
                <td class="col-num col-short">{{ (insert.ShortProd or 0)|int if insert.ShortProd > 0 else '-' }}</td>
                <td class="col-sets">{{ insert.SetsProd if insert.SetsProd > 0 else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td class="col-part"><strong>TOTAL</strong></td>
                <td class="col-desc"></td>
                <td class="col-num"><strong id="total-onhand">0</strong></td>
                <td class="col-num group-start"><strong id="total-need">0</strong></td>
                <td class="col-num col-short"><strong id="total-short-total">-</strong></td>
                <td class="col-sets"><strong id="total-sets-total">-</strong></td>
                <td class="col-num group-start"><strong id="total-inprod">0</strong></td>
                <td class="col-num col-short"><strong id="total-short-prod">-</strong></td>
                <td class="col-sets"><strong id="total-sets-prod">-</strong></td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <div class="no-data">No insert demand found.</div>
    {% endif %}
</div>

<p class="inserts-count">
    Showing <span id="visible-count">{{ inserts|length }}</span> of {{ inserts|length }} insert(s)
</p>

<!-- Kanban Modal -->
<div id="kanban-modal" class="inserts-modal">
    <div class="inserts-modal-content">
        <div class="inserts-modal-header">
            <h3>Kanban Receipt</h3>
            <span class="inserts-modal-close">&times;</span>
        </div>
        <div class="inserts-modal-body">
            <div class="inserts-form-row">
                <label>Part:</label>
                <span id="kanban-partnum"></span>
            </div>
            <div class="inserts-form-row">
                <label>Desc:</label>
                <span id="kanban-description"></span>
            </div>
            <div class="inserts-form-row">
                <label>Quantity:</label>
                <input type="number" id="kanban-qty" min="1" value="1" autocomplete="off">
            </div>
            <div class="inserts-form-row" id="kanban-last-row" style="display: none;">
                <label>Last:</label>
                <span id="kanban-last" style="color: #f0a0a0; font-size: 0.85rem;"></span>
            </div>
            <div id="kanban-message" class="inserts-message"></div>
        </div>
        <div class="inserts-modal-footer">
            <button id="kanban-cancel" class="inserts-btn inserts-btn-cancel">Cancel</button>
            <button id="kanban-submit" class="inserts-btn inserts-btn-submit">Submit</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const hideNoShortage = document.getElementById('hide-no-shortage');
    
    function updateTotals() {
        let onhand = 0, need = 0, shortTotal = 0, setsTotal = 0;
        let inprod = 0, shortProd = 0, setsProd = 0;
        
        document.querySelectorAll('.insert-row:not(.hidden)').forEach(row => {
            const cells = row.querySelectorAll('td');
            onhand += parseInt(cells[2].textContent) || 0;
            
            // Total Demand group (columns 3, 4, 5)
            need += parseInt(cells[3].textContent) || 0;
            
            const st = cells[4].textContent.trim();
            shortTotal += (st === '-' ? 0 : parseInt(st)) || 0;
            
            const stt = cells[5].textContent.trim();
            setsTotal += (stt === '-' ? 0 : parseInt(stt)) || 0;
            
            // In Production group (columns 6, 7, 8)
            const ip = cells[6].textContent.trim();
            inprod += (ip === '-' ? 0 : parseInt(ip)) || 0;
            
            const sp = cells[7].textContent.trim();
            shortProd += (sp === '-' ? 0 : parseInt(sp)) || 0;
            
            const stp = cells[8].textContent.trim();
            setsProd += (stp === '-' ? 0 : parseInt(stp)) || 0;
        });
        
        document.getElementById('total-onhand').textContent = onhand;
        document.getElementById('total-need').textContent = need;
        document.getElementById('total-short-total').textContent = shortTotal || '-';
        document.getElementById('total-sets-total').textContent = setsTotal || '-';
        document.getElementById('total-inprod').textContent = inprod || '-';
        document.getElementById('total-short-prod').textContent = shortProd || '-';
        document.getElementById('total-sets-prod').textContent = setsProd || '-';
    }
    
    function applyFilter() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const hideZeroShortage = hideNoShortage ? hideNoShortage.checked : false;
        let count = 0;
        
        document.querySelectorAll('.insert-row').forEach(row => {
            const partNum = row.dataset.partnum.toLowerCase();
            const desc = row.dataset.description.toLowerCase();
            const shortage = parseInt(row.dataset.shortage) || 0;
            
            const searchMatch = !searchTerm || partNum.includes(searchTerm) || desc.includes(searchTerm);
            const shortageMatch = !hideZeroShortage || shortage > 0;
            
            const show = searchMatch && shortageMatch;
            row.classList.toggle('hidden', !show);
            if (show) count++;
        });
        
        document.getElementById('visible-count').textContent = count;
        updateTotals();
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', applyFilter);
    }
    
    if (hideNoShortage) {
        hideNoShortage.addEventListener('change', applyFilter);
    }
    
    updateTotals();
    
    // ============================================
    // KANBAN MODAL
    // ============================================
    
    function getStoredEmployee() {
        const stored = localStorage.getItem('thequeue_employee');
        return stored ? JSON.parse(stored) : null;
    }
    
    const modal = document.getElementById('kanban-modal');
    const closeBtn = document.querySelector('.inserts-modal-close');
    const cancelBtn = document.getElementById('kanban-cancel');
    const submitBtn = document.getElementById('kanban-submit');
    const qtyInput = document.getElementById('kanban-qty');
    const message = document.getElementById('kanban-message');
    let currentPart = null;
    
    async function openModal(partnum, desc) {
        currentPart = partnum;
        document.getElementById('kanban-partnum').textContent = partnum;
        document.getElementById('kanban-description').textContent = desc || '-';
        qtyInput.value = 1;
        message.className = 'inserts-message';
        submitBtn.disabled = false;
        
        // Reset last receipt display
        const lastRow = document.getElementById('kanban-last-row');
        const lastSpan = document.getElementById('kanban-last');
        lastRow.style.display = 'none';
        lastSpan.textContent = '';
        
        modal.style.display = 'block';
        qtyInput.focus();
        qtyInput.select();
        
        // Fetch last receipt
        try {
            const resp = await fetch(`/api/kanban/last/${partnum}`);
            const data = await resp.json();
            if (data && data.TranQty) {
                const qty = Math.round(data.TranQty);
                const date = data.TranDate || '';
                const name = data.EmployeeName || data.EntryPerson || 'Unknown';
                lastSpan.textContent = `${qty} @ ${date} by ${name}`;
                lastRow.style.display = 'flex';
            }
        } catch (e) {
            // Silently ignore - not critical
        }
    }
    
    function closeModal() { modal.style.display = 'none'; }
    
    document.querySelectorAll('.insert-row').forEach(row => {
        row.addEventListener('click', () => {
            if (!getStoredEmployee()) { alert('Please log in first.'); return; }
            openModal(row.dataset.partnum, row.dataset.description);
        });
    });
    
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    window.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    qtyInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); submitBtn.click(); } });
    
    submitBtn.addEventListener('click', async () => {
        const emp = getStoredEmployee();
        if (!emp) { message.textContent = 'Not logged in.'; message.className = 'inserts-message error'; return; }
        const qty = parseInt(qtyInput.value, 10);
        if (!qty || qty < 1) { message.textContent = 'Enter a valid quantity.'; message.className = 'inserts-message error'; return; }
        
        submitBtn.disabled = true;
        message.textContent = 'Processing...';
        message.className = 'inserts-message processing';
        
        try {
            const resp = await fetch('/api/kanban/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ empId: emp.id, partNum: currentPart, quantity: qty })
            });
            const result = await resp.json();
            if (result.success) {
                message.textContent = result.message || 'Success';
                message.className = 'inserts-message success';
                setTimeout(() => { closeModal(); location.reload(); }, 1000);
            } else {
                message.textContent = result.error || 'Failed';
                message.className = 'inserts-message error';
                submitBtn.disabled = false;
            }
        } catch (e) {
            message.textContent = 'Error: ' + e.message;
            message.className = 'inserts-message error';
            submitBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
