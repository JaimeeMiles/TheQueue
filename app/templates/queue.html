{% extends "base.html" %}

{% block title %}The Queue - {{ workcell_name }}{% endblock %}

{% block content %}
<div class="queue-header">
    <div class="queue-title-row">
        <a href="{{ url_for('views.index') }}" class="back-btn">‚Üê Back</a>
        <h2>{{ workcell_name }}</h2>
    </div>
    <div class="mass-actions">
        {% if workcell_config.show_mass_actions|default(true) %}
        <button class="start-btn mass-btn">Mass Start</button>
        <button class="end-btn mass-btn">Mass End</button>
        {% endif %}
        {% if 'kanban' in (workcell_config.custom_buttons or []) %}
        <button class="kanban-btn mass-btn">Kanban</button>
        {% endif %}
    </div>
    <button onclick="location.reload()" class="refresh-btn">üîÑ Refresh Data</button>
</div>

{% if jobs %}
<div class="filter-row">
    <div class="op-filters">
        <button class="op-filter-btn active" data-op="all">All</button>
        {% set ops = jobs | map(attribute='OpCode') | unique | list %}
        {% for op in ops %}
        <button class="op-filter-btn" data-op="{{ op }}">{{ op }}</button>
        {% endfor %}
    </div>
    
    <input type="text" id="search-box" class="search-box" placeholder="Search jobs..." autocomplete="off">
    
    {% if workcell_config.group_by_material %}
    <div class="material-filter">
        <select id="material-select" class="material-select">
            <option value="all">Loading materials...</option>
        </select>
    </div>
    {% endif %}
    
    {% if workcell_config.group_by_color %}
    <div class="color-filter">
        <select id="color-select" class="color-select">
            <option value="all">Loading colors...</option>
        </select>
    </div>
    {% endif %}
    
    {% if workcell_config.filter_by_resource %}
    <div class="resource-filter">
        <select id="resource-select" class="resource-select">
            <option value="all">Loading resources...</option>
        </select>
    </div>
    {% endif %}
    
    {% if workcell_config.filter_by_capability %}
    <div class="capability-filter">
        <select id="capability-select" class="capability-select">
            <option value="all">Loading capabilities...</option>
        </select>
    </div>
    {% endif %}
</div>
{% endif %}

{% set columns = workcell_config.columns %}

<div id="job-queue">
    {% if jobs %}
    <table class="job-table" id="job-table">
        <thead>
            <tr>
                <th class="col-select"><input type="checkbox" id="select-all" title="Select all"></th>
                {% if 'startdate' in columns %}<th data-sort="StartDate" class="sortable col-date">Start <span class="sort-icon"></span></th>{% endif %}
                {% if 'operation' in columns %}<th data-sort="OpCode" class="sortable col-op">Operation <span class="sort-icon"></span></th>{% endif %}
                {% if 'job' in columns %}<th data-sort="JobNum" class="sortable col-job">Job # <span class="sort-icon"></span></th>{% endif %}
                {% if 'part' in columns %}<th data-sort="PartNum" class="sortable col-part">Part <span class="sort-icon"></span></th>{% endif %}
                {% if 'description' in columns %}<th data-sort="PartDescription" class="sortable col-desc">Description <span class="sort-icon"></span></th>{% endif %}
                {% if 'left' in columns %}<th data-sort="QtyLeft" class="sortable col-qty">Left <span class="sort-icon"></span></th>{% endif %}
                {% if 'available' in columns %}<th data-sort="QtyAvailable" class="sortable col-qty">Avail <span class="sort-icon"></span></th>{% endif %}
                {% if 'mtl' in columns %}<th data-sort="MtlStatus" class="sortable col-mtl">Mtl <span class="sort-icon"></span></th>{% endif %}
            </tr>
        </thead>
        <tbody id="job-tbody">
            {% for job in jobs %}
            {% set qty_available = (job.QtyFromPrior or 0) - (job.QtyCompletedThisOp or 0) %}
            <tr class="job-row" 
                data-job="{{ job.JobNum }}" 
                data-jobkey="{{ job.JobNum }}-{{ job.AssemblySeq }}-{{ job.OprSeq }}"
                data-asm="{{ job.AssemblySeq }}"
                data-opr="{{ job.OprSeq }}"
                data-opcode="{{ job.OpCode }}"
                data-partnum="{{ job.PartNum }}"
                data-mtl-status="{{ job.MtlStatus }}"
                data-qty-completed="{{ job.QtyCompletedThisOp or 0 }}"
                data-qty-available="{{ qty_available if not job.IsFirstOp else '' }}"
                data-is-first-op="{{ job.IsFirstOp }}"
                data-notes="{{ job.Notes or '' }}"
                data-nextlocation="{{ job.NextLocation or '' }}"
                data-ophours="{{ job.OpHours or 0 }}"
                data-cycle="{{ job.CycleTime or 0 }}"
                data-finishcolor="{{ job.FinishColor or '' }}"
                data-preptime="{{ job.PrepTime or 0 }}"
                data-machload="{{ job.MachLoad or 0 }}"
                data-machrun="{{ job.MachRun or 0 }}"
                data-machunload="{{ job.MachUnload or 0 }}"
                data-machprogram="{{ job.MachProgram or '' }}"
                data-priority="{{ job.Priority or '' }}"
                data-pdfpath="{{ job.PdfPath or '' }}"
                data-resourceid="{{ job.ResourceID or '' }}"
                data-capabilityid="{{ job.CapabilityID or '' }}">
                
                <td class="col-select"><input type="checkbox" class="row-select" onclick="event.stopPropagation()"></td>
                
                {% if 'startdate' in columns %}
                <td data-value="{{ job.StartDate.strftime('%Y-%m-%d') if job.StartDate else '' }}" class="col-date">{{ job.StartDate.strftime('%m/%d') if job.StartDate else '-' }}</td>
                {% endif %}
                
                {% if 'operation' in columns %}
                <td data-value="{{ job.OpCode }}" class="col-op">{{ job.OprSeq }}-{{ job.OpCode }}</td>
                {% endif %}
                
                {% if 'job' in columns %}
                <td data-value="{{ job.JobNum }}" class="col-job"><span class="job-num">{{ job.JobNum }}</span></td>
                {% endif %}
                
                {% if 'part' in columns %}
                <td data-value="{{ job.PartNum }}" class="col-part">{{ job.PartNum }}</td>
                {% endif %}
                
                {% if 'description' in columns %}
                <td data-value="{{ job.PartDescription or '' }}" class="col-desc">{{ job.PartDescription or '-' }}</td>
                {% endif %}
                
                {% if 'left' in columns %}
                <td data-value="{{ job.QtyLeft or 0 }}" class="col-qty">{{ (job.QtyLeft or 0)|int }}</td>
                {% endif %}
                
                {% if 'available' in columns %}
                <td data-value="{{ qty_available if not job.IsFirstOp else -1 }}" class="col-qty">
                    {% if job.IsFirstOp %}-{% else %}{{ qty_available|int }}{% endif %}
                </td>
                {% endif %}
                
                {% if 'mtl' in columns %}
                <td data-value="{{ job.MtlStatus }}" class="col-mtl">
                    {% if job.MtlStatus == 'star' %}
                    <span class="mtl-star" title="Full - covers all demand">‚òÖ</span>
                    {% elif job.MtlStatus == 'check' %}
                    <span class="mtl-check" title="Job OK - covers this job">‚úì</span>
                    {% elif job.MtlStatus == 'partial' %}
                    <span class="mtl-partial" title="Partial - can do some">‚ö†</span>
                    {% elif job.MtlStatus == 'missing' %}
                    <span class="mtl-missing" title="None - materials needed">‚úó</span>
                    {% else %}
                    <span class="mtl-none" title="No materials required">-</span>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No Jobs Ready</h3>
        <p>There are no jobs currently waiting for this work cell.</p>
    </div>
    {% endif %}
</div>

<!-- Single detail panel - fixed at bottom of viewport -->
{% if jobs %}
<div id="detail-panel" class="detail-panel hidden">
    <div class="detail-panel-header">
        <span id="detail-panel-title"></span>
        <div class="detail-panel-actions">
            <button class="viewpdf-btn" id="panel-viewpdf-btn" style="display: none;">View PDF</button>
            {% if workcell_config.show_mass_actions|default(true) %}
            <button class="start-btn" id="panel-start-btn">Start</button>
            <button class="end-btn" id="panel-end-btn">End</button>
            {% endif %}
            <button id="detail-panel-close" class="detail-panel-close">‚úï</button>
        </div>
    </div>
    <div id="detail-panel-content" class="detail-content"></div>
</div>
{% endif %}

<!-- Single End Modal - Full Job Details -->
<div id="single-end-modal" class="labor-modal hidden">
    <div class="single-end-modal-content">
        <div class="single-end-header">
            <h3 id="single-end-title">End Activity</h3>
            <button class="viewpdf-btn" id="single-end-pdf-btn" style="display: none;">View PDF</button>
            <button class="modal-close-btn" id="single-end-close">‚úï</button>
        </div>
        
        <div class="single-end-job-info">
            <div id="single-end-part-info"></div>
        </div>
        
        <div class="single-end-qty-row" id="single-end-qty-row">
            <!-- Qty, Done, Left, Avail, Mtl will be populated here -->
        </div>
        
        <div class="single-end-columns">
            <div class="single-end-col" id="single-end-operations"></div>
            <div class="single-end-col" id="single-end-materials"></div>
        </div>
        
        <div class="single-end-input-section">
            <div class="labor-input-row">
                <div class="labor-input-group">
                    <label for="single-end-qty">Completed</label>
                    <input type="number" id="single-end-qty" class="labor-input" min="0" step="1" value="">
                </div>
                <div class="labor-input-group">
                    <label for="single-end-scrap">Scrap</label>
                    <input type="number" id="single-end-scrap" class="labor-input" min="0" step="1" value="0">
                </div>
                <div class="labor-input-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="single-end-done">
                        <span>Mark Complete</span>
                    </label>
                </div>
            </div>
            <div id="single-end-first-op-options" class="first-op-options" style="display: none;">
                <label class="checkbox-label">
                    <input type="checkbox" id="single-end-set-job-qty" checked>
                    <span>Set job quantity to match completed</span>
                </label>
            </div>
            <div id="single-end-warning" class="qty-warning" style="display: none;"></div>
            <div id="single-end-error" class="labor-modal-error"></div>
        </div>
        
        <div id="single-end-other-jobs" class="other-active-jobs"></div>
        
        <div class="labor-modal-buttons">
            <button id="single-end-cancel" class="labor-modal-btn cancel-btn">Cancel</button>
            <button id="single-end-submit" class="labor-modal-btn submit-btn">End Activity</button>
        </div>
    </div>
</div>

<!-- Mass End Modal - Quick Grid -->
<div id="mass-end-modal" class="labor-modal hidden">
    <div class="mass-end-modal-content">
        <div class="mass-end-header">
            <h3>End Activities</h3>
            <button class="modal-close-btn" id="mass-end-close">‚úï</button>
        </div>
        
        <div class="mass-end-controls">
            <label><input type="checkbox" id="mass-end-select-all"> Select All</label>
            <div class="quick-fill-row">
                <span class="quick-fill-label">Quick Fill:</span>
                <button type="button" class="quick-fill-btn" onclick="quickFill(1)">1</button>
                <button type="button" class="quick-fill-btn" onclick="quickFill(2)">2</button>
                <button type="button" class="quick-fill-btn" onclick="quickFillLeft()">Left</button>
                <span class="quick-fill-divider">|</span>
                <input type="number" id="quick-fill-custom" class="quick-fill-input" min="1" step="1" placeholder="#">
                <button type="button" class="quick-fill-btn" onclick="quickFillCustom()">Fill</button>
            </div>
        </div>
        
        <div id="mass-end-warning" class="qty-warning" style="display: none;"></div>
        
        <div class="mass-end-table-wrapper">
            <table class="mass-end-table">
                <thead>
                    <tr>
                        <th class="col-check"></th>
                        <th>Job</th>
                        <th>Part</th>
                        <th>Description</th>
                        <th>Op</th>
                        <th class="col-qty">Qty</th>
                        <th class="col-qty">Left</th>
                        <th class="col-qty">Avail</th>
                        <th class="col-input">Complete</th>
                        <th class="col-input">Scrap</th>
                        <th class="col-done">Done</th>
                    </tr>
                </thead>
                <tbody id="mass-end-tbody">
                    <!-- Rows populated dynamically -->
                </tbody>
            </table>
        </div>
        
        <div id="mass-end-error" class="labor-modal-error"></div>
        
        <div class="labor-modal-buttons">
            <button id="mass-end-cancel" class="labor-modal-btn cancel-btn">Cancel</button>
            <button id="mass-end-submit" class="labor-modal-btn submit-btn">End Selected</button>
        </div>
    </div>
</div>

<p class="job-count">
    Showing <span id="visible-count">{{ jobs|length }}</span> of {{ jobs|length }} job(s)
    <span id="pagination-controls" class="pagination-controls"></span>
</p>
{% endblock %}

{% block scripts %}
<script>
console.log('TheQueue script starting...');

const workcellId = "{{ workcell_id }}";
const workcellConfig = {{ workcell_config | tojson }};
const detailFields = workcellConfig.detail_fields || [];

// Pre-loaded job details - keeps DOM light
const jobDetails = {
{% for job in jobs %}
    "{{ job.JobNum }}-{{ job.AssemblySeq }}-{{ job.OprSeq }}": {
        operations: {{ job.OperationsJSON|safe or '[]' }},
        materials: {{ job.MaterialsJSON|safe or '[]' }},
        pdfPath: "{{ job.PdfPath|default('', true)|replace('\\', '\\\\')|safe }}"
    }{% if not loop.last %},{% endif %}
{% endfor %}
};

// Current sort state
let currentSort = { column: null, direction: 'asc' };

// Pagination
const PAGE_SIZE = 200;
let currentPage = 1;
let filteredRows = [];  // Rows that pass current filters

// Current filters
let currentOpFilter = 'all';
let currentMaterialFilter = 'all';
let currentColorFilter = 'all';
let currentResourceFilter = 'all';
let currentCapabilityFilter = 'all';
let materialJobKeys = null;  // null = show all, array = show only these
let colorJobKeys = null;  // null = show all, array = show only these
let resourceJobKeys = null;  // null = show all, array = show only these
let capabilityJobKeys = null;  // null = show all, array = show only these

// Detail panel references (declared early for use in applyFilters)
let currentExpandedRow = null;
let currentPdfPath = null;  // Track PDF path for View PDF button
const detailPanel = document.getElementById('detail-panel');
const detailPanelContent = document.getElementById('detail-panel-content');
const detailPanelTitle = document.getElementById('detail-panel-title');
const detailPanelClose = document.getElementById('detail-panel-close');
const viewPdfBtn = document.getElementById('panel-viewpdf-btn');

// --- OPERATION FILTER BUTTONS ---
document.querySelectorAll('.op-filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.op-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentOpFilter = btn.dataset.op;
        applyFilters();
    });
});

// --- MATERIAL FILTER DROPDOWN ---
const materialSelect = document.getElementById('material-select');
if (materialSelect) {
    // Load materials in background
    fetch('/api/materials/{{ workcell_id }}')
        .then(response => response.json())
        .then(materials => {
            materialSelect.innerHTML = '<option value="all">All Materials</option>';
            materials.forEach(mtl => {
                const option = document.createElement('option');
                option.value = mtl.PartNum;
                option.textContent = mtl.PartDescription || mtl.PartNum;
                materialSelect.appendChild(option);
            });
        })
        .catch(err => {
            materialSelect.innerHTML = '<option value="all">All Materials</option>';
            console.error('Failed to load materials:', err);
        });
    
    materialSelect.addEventListener('change', () => {
        currentMaterialFilter = materialSelect.value;
        if (currentMaterialFilter === 'all') {
            materialJobKeys = null;
            applyFilters();
        } else {
            // Fetch jobs that use this material
            fetch('/api/jobs_by_material/{{ workcell_id }}/' + encodeURIComponent(currentMaterialFilter))
                .then(response => response.json())
                .then(jobKeys => {
                    materialJobKeys = jobKeys;
                    applyFilters();
                })
                .catch(err => {
                    console.error('Failed to load jobs by material:', err);
                    materialJobKeys = null;
                    applyFilters();
                });
        }
    });
}

// --- COLOR FILTER DROPDOWN ---
const colorSelect = document.getElementById('color-select');
if (colorSelect) {
    // Load colors in background
    fetch('/api/colors/{{ workcell_id }}')
        .then(response => response.json())
        .then(colors => {
            colorSelect.innerHTML = '<option value="all">All Colors</option>';
            colors.forEach(c => {
                const option = document.createElement('option');
                option.value = c.FinishColor;
                option.textContent = c.FinishColor;
                colorSelect.appendChild(option);
            });
        })
        .catch(err => {
            colorSelect.innerHTML = '<option value="all">All Colors</option>';
            console.error('Failed to load colors:', err);
        });
    
    colorSelect.addEventListener('change', () => {
        currentColorFilter = colorSelect.value;
        if (currentColorFilter === 'all') {
            colorJobKeys = null;
            applyFilters();
        } else {
            // Fetch jobs that use this color
            fetch('/api/jobs_by_color/{{ workcell_id }}/' + encodeURIComponent(currentColorFilter))
                .then(response => response.json())
                .then(jobKeys => {
                    colorJobKeys = jobKeys;
                    applyFilters();
                })
                .catch(err => {
                    console.error('Failed to load jobs by color:', err);
                    colorJobKeys = null;
                    applyFilters();
                });
        }
    });
}

// --- RESOURCE FILTER DROPDOWN ---
const resourceSelect = document.getElementById('resource-select');
if (resourceSelect) {
    // Load resources in background
    fetch('/api/resources/{{ workcell_id }}')
        .then(response => response.json())
        .then(resources => {
            resourceSelect.innerHTML = '<option value="all">All Resources</option>';
            resources.forEach(r => {
                const option = document.createElement('option');
                option.value = r.ResourceID;
                option.textContent = r.ResourceID;
                resourceSelect.appendChild(option);
            });
        })
        .catch(err => {
            resourceSelect.innerHTML = '<option value="all">All Resources</option>';
            console.error('Failed to load resources:', err);
        });
    
    resourceSelect.addEventListener('change', () => {
        currentResourceFilter = resourceSelect.value;
        if (currentResourceFilter === 'all') {
            resourceJobKeys = null;
            applyFilters();
        } else {
            // Fetch jobs that use this resource
            fetch('/api/jobs_by_resource/{{ workcell_id }}/' + encodeURIComponent(currentResourceFilter))
                .then(response => response.json())
                .then(jobKeys => {
                    resourceJobKeys = jobKeys;
                    applyFilters();
                })
                .catch(err => {
                    console.error('Failed to load jobs by resource:', err);
                    resourceJobKeys = null;
                    applyFilters();
                });
        }
    });
}

// --- CAPABILITY FILTER DROPDOWN ---
const capabilitySelect = document.getElementById('capability-select');
if (capabilitySelect) {
    // Load capabilities in background
    fetch('/api/capabilities/{{ workcell_id }}')
        .then(response => response.json())
        .then(capabilities => {
            capabilitySelect.innerHTML = '<option value="all">All Capabilities</option>';
            capabilities.forEach(c => {
                const option = document.createElement('option');
                option.value = c.CapabilityID;
                option.textContent = c.CapabilityID;
                capabilitySelect.appendChild(option);
            });
        })
        .catch(err => {
            capabilitySelect.innerHTML = '<option value="all">All Capabilities</option>';
            console.error('Failed to load capabilities:', err);
        });
    
    capabilitySelect.addEventListener('change', () => {
        currentCapabilityFilter = capabilitySelect.value;
        if (currentCapabilityFilter === 'all') {
            capabilityJobKeys = null;
            applyFilters();
        } else {
            // Fetch jobs that use this capability
            fetch('/api/jobs_by_capability/{{ workcell_id }}/' + encodeURIComponent(currentCapabilityFilter))
                .then(response => response.json())
                .then(jobKeys => {
                    capabilityJobKeys = jobKeys;
                    applyFilters();
                })
                .catch(err => {
                    console.error('Failed to load jobs by capability:', err);
                    capabilityJobKeys = null;
                    applyFilters();
                });
        }
    });
}

function applyFilters() {
    const searchQuery = document.getElementById('search-box').value.toLowerCase();
    const tbody = document.getElementById('job-tbody');
    const allRows = Array.from(tbody.querySelectorAll('.job-row'));
    
    // Step 1: Find all rows that match filters
    filteredRows = allRows.filter(row => {
        const text = row.textContent.toLowerCase();
        const opCode = row.dataset.opcode;
        const jobKey = row.dataset.jobkey;
        
        const matchesSearch = searchQuery === '' || text.includes(searchQuery);
        const matchesOp = currentOpFilter === 'all' || opCode === currentOpFilter;
        const matchesMaterial = materialJobKeys === null || materialJobKeys.includes(jobKey);
        const matchesColor = colorJobKeys === null || colorJobKeys.includes(jobKey);
        const matchesResource = resourceJobKeys === null || resourceJobKeys.includes(jobKey);
        const matchesCapability = capabilityJobKeys === null || capabilityJobKeys.includes(jobKey);
        
        return matchesSearch && matchesOp && matchesMaterial && matchesColor && matchesResource && matchesCapability;
    });
    
    // Reset to page 1 when filters change
    currentPage = 1;
    
    // Step 2: Show only current page
    showCurrentPage(allRows);
}

function showCurrentPage(allRows) {
    if (!allRows) {
        allRows = Array.from(document.getElementById('job-tbody').querySelectorAll('.job-row'));
    }
    
    const startIdx = (currentPage - 1) * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageRows = new Set(filteredRows.slice(startIdx, endIdx));
    
    // Hide all, show only current page
    allRows.forEach(row => {
        row.style.display = pageRows.has(row) ? '' : 'none';
    });
    
    // Close panel if expanded row is now hidden
    if (currentExpandedRow && !pageRows.has(currentExpandedRow)) {
        detailPanel.classList.add('hidden');
        currentExpandedRow.classList.remove('expanded');
        currentExpandedRow = null;
    }
    
    // Update counts and pagination
    const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
    document.getElementById('visible-count').textContent = filteredRows.length;
    updatePaginationControls(totalPages);
}

function updatePaginationControls(totalPages) {
    const container = document.getElementById('pagination-controls');
    if (!container) return;
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Prev</button>`;
    html += `<span class="page-info">Page ${currentPage} of ${totalPages}</span>`;
    html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &raquo;</button>`;
    
    container.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    showCurrentPage();
}

// --- ROW EXPANSION ---
if (detailPanelClose) {
    detailPanelClose.addEventListener('click', (e) => {
        e.stopPropagation();
        detailPanel.classList.add('hidden');
        if (currentExpandedRow) {
            currentExpandedRow.classList.remove('expanded');
            currentExpandedRow = null;
        }
        currentPdfPath = null;
    });
}

// --- VIEW PDF BUTTON ---
if (viewPdfBtn) {
    viewPdfBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentPdfPath) {
            window.open('/api/pdf?path=' + encodeURIComponent(currentPdfPath), '_blank');
        }
    });
}

document.querySelectorAll('.job-row').forEach(row => {
    row.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // If clicking same row, close panel
        if (currentExpandedRow === row) {
            detailPanel.classList.add('hidden');
            row.classList.remove('expanded');
            currentExpandedRow = null;
            currentPdfPath = null;
            return;
        }
        
        // Close previous
        if (currentExpandedRow) {
            currentExpandedRow.classList.remove('expanded');
        }
        
        // Expand new
        row.classList.add('expanded');
        currentExpandedRow = row;
        
        const jobNum = row.dataset.job;
        const asmSeq = row.dataset.asm;
        const oprSeq = row.dataset.opr;
        const partNum = row.dataset.partnum;
        const qtyCompleted = row.dataset.qtyCompleted;
        
        // Get PDF path from jobDetails
        const key = `${jobNum}-${asmSeq}-${oprSeq}`;
        const details = jobDetails[key] || {};
        currentPdfPath = details.pdfPath || null;
        
        // Show/hide View PDF button
        if (viewPdfBtn) {
            viewPdfBtn.style.display = currentPdfPath ? '' : 'none';
        }
        
        const extraData = {
            notes: row.dataset.notes,
            nextlocation: row.dataset.nextlocation,
            ophours: row.dataset.ophours,
            cycle: row.dataset.cycle,
            material: row.dataset.material,
            finishcolor: row.dataset.finishcolor,
            preptime: row.dataset.preptime,
            machload: row.dataset.machload,
            machrun: row.dataset.machrun,
            machunload: row.dataset.machunload,
            machprogram: row.dataset.machprogram,
            priority: row.dataset.priority,
            qtyAvailable: row.dataset.qtyAvailable,
            isFirstOp: row.dataset.isFirstOp,
            mtlStatus: row.dataset.mtlStatus,
            resourceid: row.dataset.resourceid,
            capabilityid: row.dataset.capabilityid
        };
        
        const description = row.querySelector('.col-desc')?.textContent?.trim() || '';
        detailPanelTitle.textContent = `Job ${jobNum} - ${partNum}${description ? ' - ' + description : ''}`;
        loadJobDetails(jobNum, asmSeq, oprSeq, partNum, qtyCompleted, extraData, detailPanelContent, row);
        detailPanel.classList.remove('hidden');
        
        // Scroll row into view above the panel
        setTimeout(() => {
            const panelHeight = detailPanel.offsetHeight;
            const rowRect = row.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            // If row is in the bottom half (would be covered by panel), scroll it up
            if (rowRect.bottom > viewportHeight - panelHeight) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 50);
    });
});

function formatDate(dateStr) {
    if (!dateStr) return '-';
    
    // Try parsing as Date object first
    const d = new Date(dateStr);
    if (!isNaN(d.getTime())) {
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${month}/${day}`;
    }
    
    // Fallback: try splitting ISO format
    const parts = dateStr.split('T')[0].split('-');
    if (parts.length === 3) {
        return `${parts[1]}/${parts[2]}`;
    }
    return '-';
}

function formatLastEntry(dateStr) {
    if (!dateStr) return '-';
    
    // Parse YYYY-MM-DD format
    const parts = dateStr.split('-');
    if (parts.length !== 3) return dateStr;
    
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    
    // Check if more than a year ago
    const entryDate = new Date(dateStr);
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    
    if (entryDate < oneYearAgo) {
        // Show MM/DD/YY for old dates
        return `${month}/${day}/${year.slice(-2)}`;
    } else {
        // Show MM/DD for recent dates
        return `${month}/${day}`;
    }
}

function loadJobDetails(jobNum, asmSeq, oprSeq, partNum, qtyCompleted, extraData, content, row) {
    
    // Get data from JavaScript object - NOT from DOM
    const key = `${jobNum}-${asmSeq}-${oprSeq}`;
    const details = jobDetails[key] || { operations: [], materials: [] };
    const operations = details.operations || [];
    const materials = details.materials || [];
    
    const materialLimit = workcellConfig.material_limit;
    const showLastCheckin = detailFields.includes('last_checkin');
    
    let html = '';
    
    // Job info row - we have ProdQty from the row, calculate from there
    const prodQty = parseInt(row.querySelector('.col-qty')?.textContent) + parseInt(qtyCompleted) || 0;
    const left = prodQty - qtyCompleted;
    
    html += '<div class="job-info-row">';
    
    // Group 1: Priority - REMOVED
    
    // Group 2: Quantities (larger display)
    html += '<div class="info-group qty-group">';
    if (detailFields.includes('qty')) {
        html += `<div class="info-item qty-item"><span class="info-label">Qty</span><span class="info-value">${Math.floor(prodQty)}</span></div>`;
    }
    if (detailFields.includes('done')) {
        html += `<div class="info-item qty-item"><span class="info-label">Done</span><span class="info-value">${Math.floor(qtyCompleted)}</span></div>`;
    }
    if (detailFields.includes('left')) {
        html += `<div class="info-item qty-item"><span class="info-label">Left</span><span class="info-value">${Math.floor(left)}</span></div>`;
    }
    // Available - show dash if first op, green if positive
    const isFirstOp = extraData.isFirstOp === '1' || extraData.isFirstOp === 'True';
    const availNum = parseInt(extraData.qtyAvailable) || 0;
    const availDisplay = isFirstOp ? '-' : Math.floor(availNum);
    const availClass = (!isFirstOp && availNum > 0) ? 'avail-positive' : '';
    html += `<div class="info-item qty-item"><span class="info-label">Avail</span><span class="info-value ${availClass}">${availDisplay}</span></div>`;
    // Material status icon
    const mtlStatus = extraData.mtlStatus || 'none';
    let mtlIcon = '-';
    let mtlTitle = 'No materials required';
    if (mtlStatus === 'star') { mtlIcon = '<span class="mtl-star">‚òÖ</span>'; mtlTitle = 'Full - covers all demand'; }
    else if (mtlStatus === 'check') { mtlIcon = '<span class="mtl-check">‚úì</span>'; mtlTitle = 'Job OK - covers this job'; }
    else if (mtlStatus === 'partial') { mtlIcon = '<span class="mtl-partial">‚ö†</span>'; mtlTitle = 'Partial - can do some'; }
    else if (mtlStatus === 'missing') { mtlIcon = '<span class="mtl-missing">‚úó</span>'; mtlTitle = 'None - materials needed'; }
    html += `<div class="info-item qty-item"><span class="info-label">Mtl</span><span class="info-value mtl-value" title="${mtlTitle}">${mtlIcon}</span></div>`;
    html += '</div>';
    
    // Group 3: Times
    const hasTimeFields = detailFields.includes('ophours') || detailFields.includes('cycle') || 
                          detailFields.includes('preptime') || detailFields.includes('machload') || 
                          detailFields.includes('machrun') || detailFields.includes('machunload');
    if (hasTimeFields) {
        html += '<div class="info-group">';
        if (detailFields.includes('cycle')) {
            html += `<div class="info-item"><span class="info-label">Cycle</span><span class="info-value">${parseFloat(extraData.cycle).toFixed(2)}</span></div>`;
        }
        if (detailFields.includes('ophours')) {
            const hours = parseFloat(extraData.ophours) || 0;
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            const opHrsDisplay = h > 0 ? `${h}h ${m}m` : `${m}m`;
            html += `<div class="info-item"><span class="info-label">Op Hrs</span><span class="info-value">${opHrsDisplay}</span></div>`;
        }
        if (detailFields.includes('preptime')) {
            html += `<div class="info-item"><span class="info-label">Prep</span><span class="info-value">${parseFloat(extraData.preptime).toFixed(2)}</span></div>`;
        }
        if (detailFields.includes('machload')) {
            html += `<div class="info-item"><span class="info-label">Load</span><span class="info-value">${parseFloat(extraData.machload).toFixed(2)}</span></div>`;
        }
        if (detailFields.includes('machrun')) {
            html += `<div class="info-item"><span class="info-label">Run</span><span class="info-value">${parseFloat(extraData.machrun).toFixed(2)}</span></div>`;
        }
        if (detailFields.includes('machunload')) {
            html += `<div class="info-item"><span class="info-label">Unload</span><span class="info-value">${parseFloat(extraData.machunload).toFixed(2)}</span></div>`;
        }
        html += '</div>';
    }
    
    // Group 4: Other fields (material, color, program, resource, capability)
    const hasOtherFields = (detailFields.includes('material') && extraData.material) ||
                           (detailFields.includes('finishcolor') && extraData.finishcolor) ||
                           (detailFields.includes('machprogram') && extraData.machprogram) ||
                           extraData.resourceid || extraData.capabilityid;
    if (hasOtherFields) {
        html += '<div class="info-group">';
        if (detailFields.includes('material') && extraData.material) {
            html += `<div class="info-item"><span class="info-label">Material</span><span class="info-value">${extraData.material}</span></div>`;
        }
        if (detailFields.includes('finishcolor') && extraData.finishcolor) {
            html += `<div class="info-item"><span class="info-label">Color</span><span class="info-value">${extraData.finishcolor}</span></div>`;
        }
        if (detailFields.includes('machprogram') && extraData.machprogram) {
            html += `<div class="info-item"><span class="info-label">Program</span><span class="info-value">${extraData.machprogram}</span></div>`;
        }
        if (extraData.resourceid) {
            html += `<div class="info-item"><span class="info-label">Resource</span><span class="info-value">${extraData.resourceid}</span></div>`;
        }
        if (extraData.capabilityid) {
            html += `<div class="info-item"><span class="info-label">Capability</span><span class="info-value">${extraData.capabilityid}</span></div>`;
        }
        html += '</div>';
    }
    
    // Group 5: Placeholder for Last Check-in (loaded async, on left side)
    if (showLastCheckin) {
        html += '<div class="info-group" id="last-checkin-group"></div>';
    }
    
    // Spacer to push next items to the right
    html += '<div class="info-spacer"></div>';
    
    // Next Location (after spacer, right side)
    if (detailFields.includes('nextlocation') && extraData.nextlocation) {
        html += '<div class="info-group info-group-right">';
        html += `<div class="info-item"><span class="info-label">Next Loc</span><span class="info-value">${extraData.nextlocation}</span></div>`;
        html += '</div>';
    }
    
    html += '</div>';
    
    // Notes on its own line if present
    if (detailFields.includes('notes') && extraData.notes) {
        html += `<div class="job-notes"><span class="notes-label">Notes:</span> ${extraData.notes}</div>`;
    }
    
    // Two-column layout: Operations left, Materials right
    html += '<div class="detail-columns">';
    
    // Operations section
    html += '<div class="detail-col">';
    if (operations.length > 0) {
        html += `
            <h4>Operations</h4>
            <table class="ops-table">
                <thead>
                    <tr>
                        <th>Seq</th>
                        <th>Operation</th>
                        <th>Cycle</th>
                        <th>Done</th>
                        <th>Last</th>
                        <th>‚úì</th>
                    </tr>
                </thead>
                <tbody>
                    ${operations.map(op => `
                        <tr class="${op.OprSeq == oprSeq ? 'current-op' : ''} ${op.OpComplete ? 'op-complete' : ''}">
                            <td>${op.OprSeq}</td>
                            <td>${op.OpCode}</td>
                            <td>${op.ProdStandard ? op.ProdStandard.toFixed(2) : '-'}</td>
                            <td>${Math.floor(op.QtyCompleted)}</td>
                            <td>${op.LastEntryDate ? formatLastEntry(op.LastEntryDate) : '-'}</td>
                            <td><input type="checkbox" ${op.OpComplete ? 'checked' : ''} disabled></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    html += '</div>';
    
    // Materials section
    html += '<div class="detail-col">';
    let displayMaterials = materials;
    let showMoreBtn = false;
    
    if (materialLimit && materials.length > materialLimit) {
        showMoreBtn = true;
        displayMaterials = materials.slice(0, materialLimit);
    }
    
    if (displayMaterials.length > 0) {
        html += `
            <h4>Materials${showMoreBtn ? ` (showing ${materialLimit} of ${materials.length})` : ''}</h4>
            <table class="mtl-table">
                <thead>
                    <tr>
                        <th>Part</th>
                        <th>Description</th>
                        <th>Req</th>
                        <th>On Hand</th>
                        <th>Demand</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${displayMaterials.map(m => {
                        const isSheet = (m.ReqUOM === 'SH100' || m.OnHandUOM === 'SH100');
                        const reqQty = isSheet ? m.RequiredQty.toFixed(2) : Math.floor(m.RequiredQty);
                        const ohQty = isSheet ? (m.OnHandQty || 0).toFixed(2) : Math.floor(m.OnHandQty || 0);
                        const demQty = isSheet ? (m.DemandQty || 0).toFixed(2) : Math.floor(m.DemandQty || 0);
                        const onHand = m.OnHandQty || 0;
                        const demand = m.DemandQty || m.RequiredQty;
                        const required = m.RequiredQty || 0;
                        let status = 'missing';
                        if (onHand >= demand) status = 'star';
                        else if (onHand >= required) status = 'check';
                        else if (onHand > 0) status = 'partial';
                        return `
                        <tr class="mtl-${status}">
                            <td>${m.PartNum}</td>
                            <td>${m.PartDescription || '-'}</td>
                            <td>${reqQty} <span class="uom">${m.ReqUOM || ''}</span></td>
                            <td>${ohQty} <span class="uom">${m.OnHandUOM || ''}</span></td>
                            <td>${demQty} <span class="uom">${m.OnHandUOM || ''}</span></td>
                            <td>
                                ${status === 'star' ? '<span class="mtl-star">‚òÖ</span>' : 
                                  status === 'check' ? '<span class="mtl-check">‚úì</span>' : 
                                  status === 'partial' ? '<span class="mtl-partial">‚ö†</span>' : 
                                  '<span class="mtl-missing">‚úó</span>'}
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        `;
        if (showMoreBtn) {
            html += `<button class="show-more-btn" onclick="showAllMaterials('${jobNum}', ${asmSeq}, ${oprSeq})">Show All ${materials.length} Materials</button>`;
        }
    } else {
        html += '<h4>Materials</h4><div class="detail-empty">No materials required</div>';
    }
    html += '</div>';
    
    html += '</div>'; // end detail-columns
    
    content.innerHTML = html;
    
    // Load last check-in for WELD (this is the only API call we keep)
    if (showLastCheckin) {
        const opCode = row.dataset.opcode;
        loadLastCheckin(partNum, opCode, content);
    }
}

function loadLastCheckin(partNum, opCode, container) {
    const url = opCode ? `/api/last_checkin/${partNum}/${opCode}` : `/api/last_checkin/${partNum}`;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data) {
                const checkinGroup = container.querySelector('#last-checkin-group');
                if (checkinGroup) {
                    checkinGroup.innerHTML = `
                        <div class="info-item last-checkin">
                            <span class="info-label">Last Check-in (${data.EmployeeName || data.EmployeeNum})</span>
                            <span class="info-value">${formatLastEntry(data.ClockInDate)} - Job ${data.JobNum} - Qty ${Math.floor(data.LaborQty)}</span>
                        </div>
                    `;
                }
            }
        })
        .catch(err => console.error('Error loading last checkin:', err));
}

function showAllMaterials(jobNum, asmSeq, oprSeq) {
    // Get materials from JavaScript object - NOT from DOM
    const key = `${jobNum}-${asmSeq}-${oprSeq}`;
    const details = jobDetails[key] || { materials: [] };
    const materials = details.materials || [];
    
    const mtlCol = document.querySelector('#detail-panel-content .detail-col:last-child');
    if (mtlCol && materials.length > 0) {
        mtlCol.innerHTML = `
            <h4>Materials (${materials.length})</h4>
            <table class="mtl-table">
                <thead>
                    <tr>
                        <th>Part</th>
                        <th>Description</th>
                        <th>Req</th>
                        <th>On Hand</th>
                        <th>Demand</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${materials.map(m => {
                        const isSheet = (m.ReqUOM === 'SH100' || m.OnHandUOM === 'SH100');
                        const reqQty = isSheet ? m.RequiredQty.toFixed(2) : Math.floor(m.RequiredQty);
                        const ohQty = isSheet ? (m.OnHandQty || 0).toFixed(2) : Math.floor(m.OnHandQty || 0);
                        const demQty = isSheet ? (m.DemandQty || 0).toFixed(2) : Math.floor(m.DemandQty || 0);
                        const onHand = m.OnHandQty || 0;
                        const demand = m.DemandQty || m.RequiredQty;
                        const required = m.RequiredQty || 0;
                        let status = 'missing';
                        if (onHand >= demand) status = 'star';
                        else if (onHand >= required) status = 'check';
                        else if (onHand > 0) status = 'partial';
                        return `
                        <tr class="mtl-${status}">
                            <td>${m.PartNum}</td>
                            <td>${m.PartDescription || '-'}</td>
                            <td>${reqQty} <span class="uom">${m.ReqUOM || ''}</span></td>
                            <td>${ohQty} <span class="uom">${m.OnHandUOM || ''}</span></td>
                            <td>${demQty} <span class="uom">${m.OnHandUOM || ''}</span></td>
                            <td>
                                ${status === 'star' ? '<span class="mtl-star">‚òÖ</span>' : 
                                  status === 'check' ? '<span class="mtl-check">‚úì</span>' : 
                                  status === 'partial' ? '<span class="mtl-partial">‚ö†</span>' : 
                                  '<span class="mtl-missing">‚úó</span>'}
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        `;
    }
}

// --- SORTING ---
document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', (e) => {
        e.stopPropagation();
        const column = th.dataset.sort;
        
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        
        sortTable(column, currentSort.direction);
        updateSortIndicators();
        applyFilters();  // Re-apply pagination after sort
    });
});

function sortTable(column, direction) {
    const tbody = document.getElementById('job-tbody');
    const rows = Array.from(tbody.querySelectorAll('.job-row'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        a.querySelectorAll('td[data-value]').forEach((td, idx) => {
            const th = document.querySelectorAll('th.sortable')[idx];
            if (th && th.dataset.sort === column) aVal = td.dataset.value;
        });
        b.querySelectorAll('td[data-value]').forEach((td, idx) => {
            const th = document.querySelectorAll('th.sortable')[idx];
            if (th && th.dataset.sort === column) bVal = td.dataset.value;
        });
        
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return direction === 'asc' ? aNum - bNum : bNum - aNum;
        }
        
        const compare = (aVal || '').localeCompare(bVal || '');
        return direction === 'asc' ? compare : -compare;
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function updateSortIndicators() {
    document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
    });
    
    if (!currentSort.column) return;
    
    const activeHeader = document.querySelector(`th[data-sort="${currentSort.column}"]`);
    if (activeHeader) {
        activeHeader.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
    }
}

// --- FILTERING (search box) ---
document.getElementById('search-box').addEventListener('input', () => applyFilters());

// --- SELECT ALL CHECKBOX ---
const selectAllCheckbox = document.getElementById('select-all');
if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        // Only select visible rows on current page
        document.querySelectorAll('.job-row').forEach(row => {
            if (row.style.display !== 'none') {
                row.querySelector('.row-select').checked = isChecked;
            }
        });
    });
}

// Initialize pagination on load
applyFilters();

// ============================================================================
// LABOR CHECK-IN FUNCTIONALITY
// ============================================================================

// Track active labor for current employee (enriched with job details)
let activeLaborRecords = []; // Full records from API
let activeLabor = {}; // key: jobKey, value: record for quick lookup

// Get current employee from localStorage
function getCurrentEmployee() {
    const stored = localStorage.getItem('thequeue_employee');
    return stored ? JSON.parse(stored) : null;
}

// Load active labor for current employee on page load
async function loadActiveLabor() {
    const emp = getCurrentEmployee();
    console.log('loadActiveLabor called, emp:', emp);
    if (!emp) return;
    
    try {
        const response = await fetch(`/api/labor/active/${emp.id}`);
        console.log('Active labor response status:', response.status);
        if (response.ok) {
            activeLaborRecords = await response.json();
            console.log('Active labor records:', activeLaborRecords);
            activeLabor = {};
            activeLaborRecords.forEach(rec => {
                const key = `${rec.JobNum}-${rec.AssemblySeq}-${rec.OprSeq}`;
                activeLabor[key] = rec;
            });
            console.log('activeLabor map:', activeLabor);
            updateStartEndButtons();
        } else {
            console.log('Active labor response not ok:', await response.text());
        }
    } catch (err) {
        console.error('Error loading active labor:', err);
    }
}

// Update Start/End button states based on active labor
function updateStartEndButtons() {
    if (!currentExpandedRow) return;
    
    const jobKey = currentExpandedRow.dataset.jobkey;
    const startBtn = document.getElementById('panel-start-btn');
    const endBtn = document.getElementById('panel-end-btn');
    
    if (!startBtn || !endBtn) return;
    
    if (activeLabor[jobKey]) {
        startBtn.disabled = true;
        startBtn.textContent = 'Started';
        endBtn.disabled = false;
        endBtn.classList.add('active');
    } else {
        startBtn.disabled = false;
        startBtn.textContent = 'Start';
        endBtn.disabled = true;
        endBtn.classList.remove('active');
    }
}

// Start Activity
async function startActivity() {
    const emp = getCurrentEmployee();
    if (!emp) {
        alert('Please log in first');
        return;
    }
    
    if (!currentExpandedRow) return;
    
    const jobNum = currentExpandedRow.dataset.job;
    const asmSeq = parseInt(currentExpandedRow.dataset.asm);
    const oprSeq = parseInt(currentExpandedRow.dataset.opr);
    const jobKey = currentExpandedRow.dataset.jobkey;
    
    const details = jobDetails[jobKey] || {};
    const operations = details.operations || [];
    const currentOp = operations.find(op => op.OprSeq == oprSeq) || {};
    const resourceGrpId = currentOp.ResourceGrpID || '';
    const resourceId = currentOp.ResourceID || '';
    const opCode = currentOp.OpCode || '';
    const jcDept = currentOp.JCDept || '';
    
    console.log('Starting activity:', { jobNum, asmSeq, oprSeq, resourceGrpId, resourceId, opCode, jcDept });
    
    const startBtn = document.getElementById('panel-start-btn');
    startBtn.disabled = true;
    startBtn.textContent = 'Starting...';
    
    try {
        const response = await fetch('/api/labor/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                empId: emp.id,
                jobNum: jobNum,
                asmSeq: asmSeq,
                oprSeq: oprSeq,
                resourceGrpId: resourceGrpId,
                resourceId: resourceId,
                opCode: opCode,
                jcDept: jcDept
            })
        });
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response body:', result);
        
        if (result.success) {
            // Reload active labor to get enriched data
            await loadActiveLabor();
            updateStartEndButtons();
        } else {
            console.error('Start failed:', result.error);
            alert('Failed to start: ' + (result.error || 'Unknown error'));
            startBtn.disabled = false;
            startBtn.textContent = 'Start';
        }
    } catch (err) {
        console.error('Start exception:', err);
        alert('Error: ' + err.message);
        startBtn.disabled = false;
        startBtn.textContent = 'Start';
    }
}

// ============================================================================
// SINGLE END MODAL
// ============================================================================

const singleEndModal = document.getElementById('single-end-modal');
let pendingSingleEnd = null;

// Track current modal state for validation
let singleEndState = {
    left: 0,
    availQty: null,
    isFirstOp: false,
    jobNum: '',
    prodQty: 0
};

function showSingleEndModal() {
    console.log('showSingleEndModal called');
    const emp = getCurrentEmployee();
    if (!emp) {
        alert('Please log in first');
        return;
    }
    
    if (!currentExpandedRow) {
        console.log('No currentExpandedRow');
        return;
    }
    
    const jobKey = currentExpandedRow.dataset.jobkey;
    console.log('jobKey:', jobKey);
    console.log('activeLabor:', activeLabor);
    const labor = activeLabor[jobKey];
    console.log('labor record:', labor);
    
    if (!labor) {
        alert('No active labor on this job');
        return;
    }
    
    const jobNum = currentExpandedRow.dataset.job;
    const asmSeq = currentExpandedRow.dataset.asm;
    const oprSeq = currentExpandedRow.dataset.opr;
    const partNum = currentExpandedRow.dataset.partnum;
    const details = jobDetails[jobKey] || {};
    const operations = details.operations || [];
    const materials = details.materials || [];
    
    pendingSingleEnd = {
        empId: emp.id,
        laborHedSeq: labor.LaborHedSeq,
        laborDtlSeq: labor.LaborDtlSeq,
        jobKey: jobKey,
        jobNum: jobNum
    };
    
    // Title
    document.getElementById('single-end-title').textContent = `End Activity - Job ${jobNum}`;
    
    // Part info
    const desc = currentExpandedRow.querySelector('.col-desc')?.textContent?.trim() || '';
    document.getElementById('single-end-part-info').innerHTML = `<strong>${partNum}</strong>${desc ? ' - ' + desc : ''}`;
    
    // PDF button
    const pdfBtn = document.getElementById('single-end-pdf-btn');
    const pdfPath = details.pdfPath;
    if (pdfPath) {
        pdfBtn.style.display = '';
        pdfBtn.onclick = () => window.open('/api/pdf?path=' + encodeURIComponent(pdfPath), '_blank');
    } else {
        pdfBtn.style.display = 'none';
    }
    
    // Quantities row
    const qtyCompleted = parseInt(currentExpandedRow.dataset.qtyCompleted) || 0;
    const leftCell = currentExpandedRow.querySelector('td[data-value]:nth-child(7)');
    const left = parseInt(leftCell?.dataset?.value) || 0;
    const prodQty = left + qtyCompleted;
    const isFirstOp = currentExpandedRow.dataset.isFirstOp === '1' || currentExpandedRow.dataset.isFirstOp === 'True';
    const availQty = isFirstOp ? null : (parseInt(currentExpandedRow.dataset.qtyAvailable) || 0);
    const mtlStatus = currentExpandedRow.dataset.mtlStatus || 'none';
    
    // Store state for validation
    singleEndState = {
        left: left,
        availQty: availQty,
        isFirstOp: isFirstOp,
        jobNum: jobNum,
        prodQty: prodQty
    };
    
    let mtlIcon = '-';
    if (mtlStatus === 'star') mtlIcon = '<span class="mtl-star">‚òÖ</span>';
    else if (mtlStatus === 'check') mtlIcon = '<span class="mtl-check">‚úì</span>';
    else if (mtlStatus === 'partial') mtlIcon = '<span class="mtl-partial">‚ö†</span>';
    else if (mtlStatus === 'missing') mtlIcon = '<span class="mtl-missing">‚úó</span>';
    
    const availDisplay = isFirstOp ? '-' : availQty;
    document.getElementById('single-end-qty-row').innerHTML = `
        <div class="qty-box"><span class="qty-label">Qty</span><span class="qty-value">${prodQty}</span></div>
        <div class="qty-box"><span class="qty-label">Done</span><span class="qty-value">${qtyCompleted}</span></div>
        <div class="qty-box"><span class="qty-label">Left</span><span class="qty-value">${left}</span></div>
        <div class="qty-box"><span class="qty-label">Avail</span><span class="qty-value ${availQty !== null && availQty > 0 ? 'avail-positive' : ''}">${availDisplay}</span></div>
        <div class="qty-box"><span class="qty-label">Mtl</span><span class="qty-value">${mtlIcon}</span></div>
    `;
    
    // Show job qty option - checked by default for first ops, unchecked for later ops
    const jobQtyOptions = document.getElementById('single-end-first-op-options');
    const jobQtyCheckbox = document.getElementById('single-end-set-job-qty');
    jobQtyOptions.style.display = '';
    jobQtyCheckbox.checked = isFirstOp;  // Default checked only for first ops
    
    // Operations table
    let opsHtml = '';
    if (operations.length > 0) {
        opsHtml = `<h4>Operations</h4><table class="ops-table"><thead><tr><th>Seq</th><th>Op</th><th>Done</th><th>‚úì</th></tr></thead><tbody>`;
        operations.forEach(op => {
            const isCurrent = op.OprSeq == oprSeq;
            opsHtml += `<tr class="${isCurrent ? 'current-op' : ''} ${op.OpComplete ? 'op-complete' : ''}">
                <td>${op.OprSeq}</td><td>${op.OpCode}</td><td>${Math.floor(op.QtyCompleted)}</td>
                <td><input type="checkbox" ${op.OpComplete ? 'checked' : ''} disabled></td></tr>`;
        });
        opsHtml += '</tbody></table>';
    }
    document.getElementById('single-end-operations').innerHTML = opsHtml;
    
    // Materials table (scrollable)
    let mtlHtml = '';
    if (materials.length > 0) {
        mtlHtml = `<h4>Materials (${materials.length})</h4><table class="mtl-table"><thead><tr><th>Part</th><th>Req</th><th>On Hand</th></tr></thead><tbody>`;
        materials.forEach(m => {
            const onHand = m.OnHandQty || 0;
            const required = m.RequiredQty || 0;
            let status = onHand >= required ? 'check' : (onHand > 0 ? 'partial' : 'missing');
            mtlHtml += `<tr class="mtl-${status}"><td>${m.PartNum}</td><td>${Math.floor(required)}</td><td>${Math.floor(onHand)}</td></tr>`;
        });
        mtlHtml += '</tbody></table>';
    }
    document.getElementById('single-end-materials').innerHTML = mtlHtml;
    
    // Other active jobs
    const otherJobs = activeLaborRecords.filter(r => `${r.JobNum}-${r.AssemblySeq}-${r.OprSeq}` !== jobKey);
    let otherHtml = '';
    if (otherJobs.length > 0) {
        const jobLinks = otherJobs.map(r => 
            `<span class="other-job-link" data-jobkey="${r.JobNum}-${r.AssemblySeq}-${r.OprSeq}">${r.JobNum} (${r.OpCode || 'Op ' + r.OprSeq})</span>`
        ).join(', ');
        otherHtml = `<div class="other-jobs-notice">‚ö† Also active: ${jobLinks}</div>`;
    }
    document.getElementById('single-end-other-jobs').innerHTML = otherHtml;
    
    // Wire up other job links to switch
    document.querySelectorAll('.other-job-link').forEach(link => {
        link.addEventListener('click', () => {
            const targetKey = link.dataset.jobkey;
            // Find and click that row if visible
            const targetRow = document.querySelector(`.job-row[data-jobkey="${targetKey}"]`);
            if (targetRow) {
                hideSingleEndModal();
                targetRow.click();
                setTimeout(() => showSingleEndModal(), 100);
            }
        });
    });
    
    // Reset inputs
    document.getElementById('single-end-qty').value = '';
    document.getElementById('single-end-scrap').value = '0';
    document.getElementById('single-end-done').checked = false;
    document.getElementById('single-end-warning').style.display = 'none';
    document.getElementById('single-end-error').textContent = '';
    
    singleEndModal.classList.remove('hidden');
    document.getElementById('single-end-qty').focus();
}

// Validate and update Single End Modal state when qty changes
function validateSingleEndQty() {
    const qtyInput = document.getElementById('single-end-qty');
    const doneCheckbox = document.getElementById('single-end-done');
    const warning = document.getElementById('single-end-warning');
    
    const qty = parseFloat(qtyInput.value) || 0;
    
    // Auto-check Done if qty >= left
    if (qty > 0 && qty >= singleEndState.left) {
        doneCheckbox.checked = true;
    } else {
        doneCheckbox.checked = false;
    }
    
    // Show warning if qty > available (for non-first ops)
    if (!singleEndState.isFirstOp && singleEndState.availQty !== null && qty > singleEndState.availQty) {
        warning.innerHTML = `‚ö†Ô∏è <strong>Warning:</strong> Quantity (${qty}) exceeds available from prior operation (${singleEndState.availQty})`;
        warning.style.display = 'block';
    } else {
        warning.style.display = 'none';
    }
}

function hideSingleEndModal() {
    singleEndModal.classList.add('hidden');
    pendingSingleEnd = null;
}

async function submitSingleEnd() {
    if (!pendingSingleEnd) return;
    
    const laborQty = parseFloat(document.getElementById('single-end-qty').value) || 0;
    const scrapQty = parseFloat(document.getElementById('single-end-scrap').value) || 0;
    const setJobQty = document.getElementById('single-end-set-job-qty').checked;
    // If setting job qty to match completed, automatically mark complete
    const markComplete = setJobQty || document.getElementById('single-end-done').checked;
    
    if (laborQty <= 0 && scrapQty <= 0) {
        document.getElementById('single-end-error').textContent = 'Please enter a quantity';
        return;
    }
    
    const submitBtn = document.getElementById('single-end-submit');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ending...';
    document.getElementById('single-end-error').textContent = '';
    
    try {
        // If set job qty is checked, update job quantity to total completed (existing + new)
        if (setJobQty && laborQty > 0) {
            // Get existing qty completed from the row
            const existingCompleted = parseInt(currentExpandedRow.dataset.qtyCompleted) || 0;
            const newJobQty = existingCompleted + laborQty;
            
            submitBtn.textContent = 'Updating job qty...';
            const qtyResponse = await fetch('/api/job/update-quantity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jobNum: pendingSingleEnd.jobNum,
                    newQty: newJobQty
                })
            });
            const qtyResult = await qtyResponse.json();
            if (!qtyResult.success) {
                document.getElementById('single-end-error').textContent = 'Failed to update job qty: ' + (qtyResult.error || 'Unknown error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'End Activity';
                return;
            }
        }
        
        submitBtn.textContent = 'Ending...';
        const response = await fetch('/api/labor/end', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                empId: pendingSingleEnd.empId,
                laborHedSeq: pendingSingleEnd.laborHedSeq,
                laborDtlSeq: pendingSingleEnd.laborDtlSeq,
                laborQty: laborQty,
                scrapQty: scrapQty,
                complete: markComplete
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await loadActiveLabor();
            hideSingleEndModal();
            updateStartEndButtons();
            // Reload page to reflect qty changes
            if (setJobQty) {
                location.reload();
            }
        } else {
            document.getElementById('single-end-error').textContent = result.error;
        }
    } catch (err) {
        document.getElementById('single-end-error').textContent = 'Error: ' + err.message;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'End Activity';
    }
}

// Single End Modal event handlers
document.getElementById('single-end-close')?.addEventListener('click', hideSingleEndModal);
document.getElementById('single-end-cancel')?.addEventListener('click', hideSingleEndModal);
document.getElementById('single-end-submit')?.addEventListener('click', submitSingleEnd);
document.getElementById('single-end-qty')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') submitSingleEnd();
});
document.getElementById('single-end-qty')?.addEventListener('input', validateSingleEndQty);

// When "Set job qty" is checked, automatically check "Mark Complete"
document.getElementById('single-end-set-job-qty')?.addEventListener('change', (e) => {
    if (e.target.checked) {
        document.getElementById('single-end-done').checked = true;
    }
});

// ============================================================================
// MASS END MODAL
// ============================================================================

const massEndModal = document.getElementById('mass-end-modal');

function showMassEndModal() {
    console.log('showMassEndModal called');
    const emp = getCurrentEmployee();
    if (!emp) {
        alert('Please log in first');
        return;
    }
    
    console.log('activeLaborRecords:', activeLaborRecords);
    
    if (activeLaborRecords.length === 0) {
        alert('No active jobs to end');
        return;
    }
    
    // Build table rows
    const tbody = document.getElementById('mass-end-tbody');
    tbody.innerHTML = activeLaborRecords.map(rec => {
        const key = `${rec.JobNum}-${rec.AssemblySeq}-${rec.OprSeq}`;
        const availDisplay = rec.QtyAvailable === null ? '-' : rec.QtyAvailable;
        const isFirstOp = rec.QtyAvailable === null;
        return `
            <tr data-labor-key="${key}" data-hed="${rec.LaborHedSeq}" data-dtl="${rec.LaborDtlSeq}" 
                data-left="${rec.QtyLeft || 0}" data-avail="${rec.QtyAvailable}" data-first-op="${isFirstOp}">
                <td><input type="checkbox" class="mass-end-check" checked></td>
                <td>${rec.JobNum}</td>
                <td>${rec.PartNum || ''}</td>
                <td>${rec.PartDescription || ''}</td>
                <td>${rec.OprSeq}-${rec.OpCode || ''}</td>
                <td class="col-qty">${rec.ProdQty || 0}</td>
                <td class="col-qty">${rec.QtyLeft || 0}</td>
                <td class="col-qty">${availDisplay}</td>
                <td class="col-input"><input type="number" class="mass-end-qty" min="0" step="1" value=""></td>
                <td class="col-input"><input type="number" class="mass-end-scrap" min="0" step="1" value="0"></td>
                <td class="col-done"><input type="checkbox" class="mass-end-done"></td>
            </tr>
        `;
    }).join('');
    
    // Add input event listeners for qty validation
    tbody.querySelectorAll('.mass-end-qty').forEach(input => {
        input.addEventListener('input', validateMassEndRow);
    });
    
    document.getElementById('mass-end-select-all').checked = true;
    document.getElementById('mass-end-warning').style.display = 'none';
    document.getElementById('mass-end-error').textContent = '';
    
    massEndModal.classList.remove('hidden');
}

// Validate Mass End row when qty changes
function validateMassEndRow(e) {
    const row = e.target.closest('tr');
    updateRowDoneCheckbox(row);
    validateMassEndWarnings();
}

// Check all rows and show warning if any qty > available
function validateMassEndWarnings() {
    const rows = document.querySelectorAll('#mass-end-tbody tr');
    const warnings = [];
    
    rows.forEach(row => {
        const qty = parseFloat(row.querySelector('.mass-end-qty').value) || 0;
        const avail = row.dataset.avail === 'null' ? null : parseFloat(row.dataset.avail);
        const isFirstOp = row.dataset.firstOp === 'true';
        const jobNum = row.querySelector('td:nth-child(2)').textContent;
        
        if (!isFirstOp && avail !== null && qty > avail) {
            warnings.push(`${jobNum}: ${qty} entered, ${avail} available`);
        }
    });
    
    const warningEl = document.getElementById('mass-end-warning');
    if (warnings.length > 0) {
        warningEl.innerHTML = `‚ö†Ô∏è <strong>Warning:</strong> Quantity exceeds available from prior operation:<br>${warnings.join('<br>')}`;
        warningEl.style.display = 'block';
    } else {
        warningEl.style.display = 'none';
    }
}

// Quick Fill functions for Mass End Modal
function quickFill(value) {
    const rows = document.querySelectorAll('#mass-end-tbody tr');
    rows.forEach(row => {
        const checked = row.querySelector('.mass-end-check').checked;
        if (!checked) return;
        
        const qtyInput = row.querySelector('.mass-end-qty');
        qtyInput.value = value;
        
        // Trigger validation for this row
        updateRowDoneCheckbox(row);
    });
    validateMassEndWarnings();
}

function quickFillLeft() {
    const rows = document.querySelectorAll('#mass-end-tbody tr');
    rows.forEach(row => {
        const checked = row.querySelector('.mass-end-check').checked;
        if (!checked) return;
        
        const left = parseFloat(row.dataset.left) || 0;
        const qtyInput = row.querySelector('.mass-end-qty');
        qtyInput.value = left;
        
        // Trigger validation for this row
        updateRowDoneCheckbox(row);
    });
    validateMassEndWarnings();
}

function quickFillCustom() {
    const customInput = document.getElementById('quick-fill-custom');
    const value = parseFloat(customInput.value);
    if (isNaN(value) || customInput.value.trim() === '') {
        customInput.focus();
        return;
    }
    quickFill(value);
    customInput.value = '';
}

// Helper to update Done checkbox for a single row
function updateRowDoneCheckbox(row) {
    const qty = parseFloat(row.querySelector('.mass-end-qty').value) || 0;
    const left = parseFloat(row.dataset.left) || 0;
    const doneCheckbox = row.querySelector('.mass-end-done');
    
    if (qty > 0 && qty >= left) {
        doneCheckbox.checked = true;
    } else {
        doneCheckbox.checked = false;
    }
}

function hideMassEndModal() {
    massEndModal.classList.add('hidden');
}

async function submitMassEnd() {
    const emp = getCurrentEmployee();
    if (!emp) return;
    
    const rows = document.querySelectorAll('#mass-end-tbody tr');
    const toEnd = [];
    
    rows.forEach(row => {
        const checked = row.querySelector('.mass-end-check').checked;
        if (!checked) return;
        
        const qty = parseFloat(row.querySelector('.mass-end-qty').value) || 0;
        const scrap = parseFloat(row.querySelector('.mass-end-scrap').value) || 0;
        const done = row.querySelector('.mass-end-done').checked;
        
        if (qty > 0 || scrap > 0) {
            toEnd.push({
                laborHedSeq: parseInt(row.dataset.hed),
                laborDtlSeq: parseInt(row.dataset.dtl),
                laborQty: qty,
                scrapQty: scrap,
                complete: done
            });
        }
    });
    
    if (toEnd.length === 0) {
        document.getElementById('mass-end-error').textContent = 'Enter quantities for at least one job';
        return;
    }
    
    const submitBtn = document.getElementById('mass-end-submit');
    submitBtn.disabled = true;
    submitBtn.textContent = `Ending ${toEnd.length}...`;
    document.getElementById('mass-end-error').textContent = '';
    
    let success = 0;
    let failed = 0;
    
    for (const item of toEnd) {
        try {
            const response = await fetch('/api/labor/end', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    empId: emp.id,
                    laborHedSeq: item.laborHedSeq,
                    laborDtlSeq: item.laborDtlSeq,
                    laborQty: item.laborQty,
                    scrapQty: item.scrapQty,
                    complete: item.complete
                })
            });
            const result = await response.json();
            if (result.success) success++;
            else failed++;
        } catch (err) {
            failed++;
        }
    }
    
    await loadActiveLabor();
    
    if (failed === 0) {
        hideMassEndModal();
        updateStartEndButtons();
    } else {
        document.getElementById('mass-end-error').textContent = `Ended ${success}, failed ${failed}`;
        // Refresh the table
        showMassEndModal();
    }
    
    submitBtn.disabled = false;
    submitBtn.textContent = 'End Selected';
}

// Mass End Modal event handlers
document.getElementById('mass-end-close')?.addEventListener('click', hideMassEndModal);
document.getElementById('mass-end-cancel')?.addEventListener('click', hideMassEndModal);
document.getElementById('mass-end-submit')?.addEventListener('click', submitMassEnd);
document.getElementById('mass-end-select-all')?.addEventListener('change', (e) => {
    document.querySelectorAll('.mass-end-check').forEach(cb => cb.checked = e.target.checked);
});

// Enter key on custom fill input
document.getElementById('quick-fill-custom')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') quickFillCustom();
});

// ============================================================================
// MASS START
// ============================================================================

async function massStart() {
    const emp = getCurrentEmployee();
    if (!emp) {
        alert('Please log in first');
        return;
    }
    
    // Get selected rows
    const selectedRows = Array.from(document.querySelectorAll('.job-row')).filter(row => 
        row.style.display !== 'none' && row.querySelector('.row-select').checked
    );
    
    if (selectedRows.length === 0) {
        alert('Please select jobs to start');
        return;
    }
    
    const massStartBtn = document.querySelector('.mass-actions .start-btn');
    massStartBtn.disabled = true;
    massStartBtn.textContent = `Starting ${selectedRows.length}...`;
    
    let success = 0;
    let failed = 0;
    let lastError = '';
    
    for (const row of selectedRows) {
        const jobKey = row.dataset.jobkey;
        
        // Skip if already active
        if (activeLabor[jobKey]) {
            continue;
        }
        
        const jobNum = row.dataset.job;
        const asmSeq = parseInt(row.dataset.asm);
        const oprSeq = parseInt(row.dataset.opr);
        
        const details = jobDetails[jobKey] || {};
        const operations = details.operations || [];
        const currentOp = operations.find(op => op.OprSeq == oprSeq) || {};
        
        console.log('Mass starting:', jobNum, { resourceGrpId: currentOp.ResourceGrpID, resourceId: currentOp.ResourceID, opCode: currentOp.OpCode, jcDept: currentOp.JCDept });
        
        try {
            const response = await fetch('/api/labor/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    empId: emp.id,
                    jobNum: jobNum,
                    asmSeq: asmSeq,
                    oprSeq: oprSeq,
                    resourceGrpId: currentOp.ResourceGrpID || '',
                    resourceId: currentOp.ResourceID || '',
                    opCode: currentOp.OpCode || '',
                    jcDept: currentOp.JCDept || ''
                })
            });
            const result = await response.json();
            console.log('Mass start result for', jobNum, ':', result);
            if (result.success) {
                success++;
            } else {
                failed++;
                lastError = result.error || 'Unknown error';
                console.error('Mass start failed for', jobNum, ':', result.error);
            }
        } catch (err) {
            failed++;
            lastError = err.message;
            console.error('Mass start exception for', jobNum, ':', err);
        }
    }
    
    await loadActiveLabor();
    updateStartEndButtons();
    
    // Uncheck all
    document.querySelectorAll('.row-select').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    
    massStartBtn.disabled = false;
    massStartBtn.textContent = 'Mass Start';
    
    if (failed > 0) {
        alert(`Started ${success} jobs, ${failed} failed.\nLast error: ${lastError}`);
    } else if (success > 0) {
        console.log(`Successfully started ${success} jobs`);
    }
}

// ============================================================================
// WIRE UP BUTTONS
// ============================================================================

console.log('Wiring up labor buttons...');

const panelStartBtn = document.getElementById('panel-start-btn');
const panelEndBtn = document.getElementById('panel-end-btn');

console.log('panelStartBtn:', panelStartBtn);
console.log('panelEndBtn:', panelEndBtn);

if (panelStartBtn) {
    panelStartBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('Start button clicked');
        startActivity();
    });
}

if (panelEndBtn) {
    panelEndBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('End button clicked');
        showSingleEndModal();
    });
}

// Mass action buttons
const massStartBtn = document.querySelector('.mass-actions .start-btn');
const massEndBtn = document.querySelector('.mass-actions .end-btn');

console.log('massStartBtn:', massStartBtn);
console.log('massEndBtn:', massEndBtn);

if (massStartBtn) {
    massStartBtn.addEventListener('click', () => {
        console.log('Mass Start button clicked');
        massStart();
    });
}

if (massEndBtn) {
    massEndBtn.addEventListener('click', () => {
        console.log('Mass End button clicked');
        showMassEndModal();
    });
}

// Close modals on escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (!singleEndModal.classList.contains('hidden')) hideSingleEndModal();
        if (!massEndModal.classList.contains('hidden')) hideMassEndModal();
    }
});

// Load active labor on page load
loadActiveLabor();

// Update buttons when a row is expanded
const originalLoadJobDetails = loadJobDetails;
loadJobDetails = function(...args) {
    originalLoadJobDetails(...args);
    setTimeout(updateStartEndButtons, 100);
};
</script>
{% endblock %}
